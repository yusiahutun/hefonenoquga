<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>How to Use a Batch File to Make PowerShell Scripts Easier to Run | GleamBlog</title><meta name=generator content="Hugo 0.98.0"><meta name=description content="Quick LinksWhy can't I just copy my .PS1 file to another computer and run it?  Step 1: Double-click to run.  Step 2: Getting around ExecutionPolicy.  Step 3: Getting Administrator access.  Step 4: Getting around custom PowerShell profiles.  Completed batch files.   For several reasons, mostly security-related, PowerShell scripts aren't as easily portable and usable as batch scripts can be. However, we can bundle a batch script with our PowerShell scripts to work around these issues."><link rel=stylesheet href=https://assets.cdnweb.info/hugo/cayman/css/normalize.css><link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel=stylesheet type=text/css><link rel=stylesheet href=https://assets.cdnweb.info/hugo/cayman/css/cayman.css><link rel=apple-touch-icon sizes=180x180 href=./apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=./favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=./favicon-16x16.png><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css integrity=sha384-yFRtMMDnQtDRO8rLpMIKrtPCD5jdktao2TV19YiZYWMDkUR5GQZR/NOVTdquEx1j crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.js integrity=sha384-9Nhn55MVVN0/4OFx7EE5kpFBPsEMZxKTCnA+4fqDmg12eCTqGi6+BB2LjY8brQxJ crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script></head><body><section class=page-header><h1 class=project-name>GleamBlog</h1><h2 class=project-tagline></h2><nav><a href=./index.html class=btn>Blog</a>
<a href=./sitemap.xml class=btn>Sitemap</a>
<a href=./index.xml class=btn>RSS</a></nav></section><section class=main-content><h1>How to Use a Batch File to Make PowerShell Scripts Easier to Run</h1><div><strong>Publish date: </strong>2024-06-18</div><h3>Quick Links</h3><ul class=table-content-level-1><li><a href=#>Why can't I just copy my .PS1 file to another computer and run it?</a></li></ul><ul class=table-content-level-1><li><a href=#>Step 1: Double-click to run.</a></li></ul><ul class=table-content-level-1><li><a href=#>Step 2: Getting around ExecutionPolicy.</a></li></ul><ul class=table-content-level-1><li><a href=#>Step 3: Getting Administrator access.</a></li></ul><ul class=table-content-level-1><li><a href=#>Step 4: Getting around custom PowerShell profiles.</a></li></ul><ul class=table-content-level-1><li><a href=#>Completed batch files.</a></li></ul><p>For several reasons, mostly security-related, PowerShell scripts aren't as easily portable and usable as batch scripts can be. However, we can bundle a batch script with our PowerShell scripts to work around these issues. Here, we'll show you a few of those problem areas, and how to build a batch script to get around them.</p><strong class="an-zone-tag-top ad-zone-advertising-tag"></strong> <strong class="an-zone-tag-bottom ad-zone-advertising-sub-tag"></strong><h2 id=why-can-t-i-just-copy-my-ps1-file-to-another-computer-and-run-it>Why can't I just copy my .PS1 file to another computer and run it?</h2><p>Unless the target system has been pre-configured to allow running of arbitrary scripts, with the required privileges, and using the right settings, chances are you're going to run into some problems when you try to do this.</p><li><strong>PowerShell is not associated to the .PS1 file extension by default.</strong>We brought this up initially in our <a href=#>PowerShell Geek School</a> series. Windows associates .PS1 files to Notepad by default, instead of sending them to the PowerShell command interpreter. This is to prevent accidental execution of malicious scripts by simply double-clicking them. There are ways you can change this behavior, but it's probably not something you want to do on every computer you're carrying your scripts around to - especially if some of those computers aren't your own.</li><li><strong>PowerShell does not allow external script execution by default.</strong>The ExecutionPolicy setting in PowerShell prevents execution of external scripts by default in all versions of Windows. In some Windows versions, the default doesn't allow script execution at all. We showed you how to change this setting in <a href=#>How to Allow the Execution of PowerShell Scripts on Windows 7</a>. However, this is also something you don't want to do on just any computer.</li><li><strong>Some PowerShell scripts won't work without Administrator permissions.</strong>Even running with an Administrator-level account, you still need to get through User Account Control (UAC) to perform certain actions. <a href=#>We don't want to disable this</a>, but it's still nice when we can make it a bit easier to deal with.</li><li><strong>Some users may have customized PowerShell environments.</strong>You probably won't run into this often, but when you do it can make running and troubleshooting your scripts a bit frustrating. Fortunately, we can get around this without making any permanent changes as well.</li><strong class="an-zone-tag-top ad-zone-advertising-tag"></strong> <strong class="an-zone-tag-bottom ad-zone-advertising-sub-tag"></strong><h2 id=step-1-double-click-to-run>Step 1: Double-click to run.</h2><p>Let's start by addressing the first problem - .PS1 file associations. You can't double-click to run .PS1 files, but you can execute a .BAT file that way. So, we'll write a batch file to call the PowerShell script from the command line for us.</p><p>So we don't have to re-write the batch file for every script, or every time we move a script around, it's going to make use of a self-referencing variable to build the file path for the PowerShell script. To make this work, the batch file will need to be placed in the same folder as your PowerShell script and have the same file name. So if your PowerShell script is called "MyScript.ps1", you'll want to name your batch file "MyScript.bat" and make sure it's in the same folder. Then, put these lines in the batch script:</p><pre>@ECHO OFF <p>PowerShell.exe -Command "&amp; '%~dpn0.ps1'"</p> <p>PAUSE</p></pre><strong class="an-zone-tag-top ad-zone-advertising-tag"></strong> <strong class="an-zone-tag-bottom ad-zone-advertising-sub-tag"></strong><p>If it weren't for the other security restrictions in place, that would really be all it takes to run a PowerShell script from a batch file. In fact, the first and last lines are mainly just a matter of preference - it's the second line that's really doing the work. Here's the breakdown:</p><p><strong>@ECHO OFF</strong> turns off command echoing. This just keeps your other commands from showing on-screen when the batch file runs. This line is itself hidden by the use of the at (@) symbol in front of it.</p><p><strong>PowerShell.exe -Command "& '%~dpn0.ps1'"</strong> actually runs the PowerShell script. PowerShell.exe can of course be called from any CMD window or batch file to launch PowerShell to a bare console like usual. You can also use it to run commands straight from a batch file, by including the -Command parameter and appropriate arguments. The way this is used to target our .PS1 file is with the special %~dpn0 variable. Run from a batch file, %~dpn0 evaluates to the drive letter, folder path, and file name (without extension) of the batch file. Since the batch file and PowerShell script will be in the same folder and have the same name, %~dpn0.ps1 will translate to the full file path of the PowerShell script.</p><strong class="an-zone-tag-top ad-zone-advertising-tag"></strong> <strong class="an-zone-tag-bottom ad-zone-advertising-sub-tag"></strong><p><strong>PAUSE</strong> just pauses the batch execution and waits for user input. This is generally useful to have at the end of your batch files, so that you have a chance to review any command output before the window disappears. As we go through testing of each step, the usefulness of this will become more obvious.</p><p>So, the basic batch file is set up. For demonstration purposes, this file is saved as "D:\Script Lab\MyScript.bat" and there's a "MyScript.ps1" in the same folder. Let's see what happens when we double-click MyScript.bat.</p><img style=margin:auto;display:block;text-align:center;max-width:100%;height:auto src=https://cdn.statically.io/img/static1.howtogeekimages.com/wordpress/wp-content/uploads/2014/11/ExecutionPolicy1.png><p>Obviously the PowerShell script didn't run, but that's to be expected - we've only addressed the first of our four problems, after all. However, there are some important bits demonstrated here:</p><strong class="an-zone-tag-top ad-zone-advertising-tag"></strong> <strong class="an-zone-tag-bottom ad-zone-advertising-sub-tag"></strong><li>The window title shows that the batch script successfully launched PowerShell.</li><li>The first line of output shows that a custom PowerShell profile is in use. This is potential problem #4, listed above.</li><li>The error message demonstrates ExecutionPolicy restrictions in effect. That's our problem #2.</li><li>The underlined part of the error message (which is done natively by PowerShell's error output) shows the batch script was correctly targeting the intended PowerShell script (D:\Script Lab\MyScript.ps1). So we at least know that much is working properly.</li><p>The profile, in this case, is a simple one-line script used for this demonstration to generate output whenever the profile is active. You can <a href=#>customize your own PowerShell profile</a> to do this too, if you want to test these scripts yourself. Simply add the following line to your profile script:</p><pre>Write-Output 'Custom PowerShell profile in effect!'</pre><strong class="an-zone-tag-top ad-zone-advertising-tag"></strong> <strong class="an-zone-tag-bottom ad-zone-advertising-sub-tag"></strong><p>The ExecutionPolicy on the test system here is set to RemoteSigned. This allows execution of scripts created locally (like the profile script), while blocking scripts from outside sources unless they're signed by a trusted authority. For demonstration purposes, the following command was used to flag MyScript.ps1 as being from an external source:</p><pre>Add-Content -Path 'D:\Script Lab\MyScript.ps1' -Value "[ZoneTransfer]`nZoneId=3" -Stream 'Zone.Identifier'</pre><p>That sets the Zone.Identifier alternate data stream on MyScript.ps1 so that Windows will think the file <a href=#>came from the Internet</a>. It can be easily reversed with the following command:</p><pre>Clear-Content -Path 'D:\Script Lab\MyScript.ps1' -Stream 'Zone.Identifier'</pre><h2 id=step-2-getting-around-executionpolicy>Step 2: Getting around ExecutionPolicy.</h2><p>Getting around the ExecutionPolicy setting, from CMD or a batch script, is actually pretty easy. We just modify the second line of the script to add one more parameter to the PowerShell.exe command.</p><strong class="an-zone-tag-top ad-zone-advertising-tag"></strong> <strong class="an-zone-tag-bottom ad-zone-advertising-sub-tag"></strong><pre>PowerShell.exe -ExecutionPolicy Bypass -Command "&amp; '%~dpn0.ps1'"</pre><p>The -ExecutionPolicy parameter can be used to modify the ExecutionPolicy that is used when you spawn a new PowerShell session. This will not persist beyond that session, so we can run PowerShell like this whenever we need without weakening the general security posture of the system. Now that we've fixed that, let's have another go at it:</p><img style=margin:auto;display:block;text-align:center;max-width:100%;height:auto src=https://cdn.statically.io/img/static1.howtogeekimages.com/wordpress/wp-content/uploads/2014/11/LimitedUser3.png><p>Now that the script has properly executed, we can see what it actually does. It's letting us know that we're running the script as a Limited user. The script is in fact being run by an account with Administrator permissions, but User Account Control is getting in the way. Though details of how the script is checking for Administrator access are beyond the scope of this article, here's the code that's being used for demonstration:</p><strong class="an-zone-tag-top ad-zone-advertising-tag"></strong> <strong class="an-zone-tag-bottom ad-zone-advertising-sub-tag"></strong><pre>if (([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")) <p>{Write-Output 'Running as Administrator!'}</p> <p>else</p> <p>{Write-Output 'Running Limited!'}</p> <p>Pause</p></pre><p>You'll also notice that there's now two "Pause" operations in the script output - one from the PowerShell script, and one from the batch file. The reason for this will be more apparent in the next step.</p><h2 id=step-3-getting-administrator-access>Step 3: Getting Administrator access.</h2><p>If your script doesn't run any commands that require elevation, and you're pretty sure you won't have to worry about anyone's custom profiles getting in the way, you can skip the rest of this. If you are running some Administrator-level cmdlets though, you'll need this piece.</p><strong class="an-zone-tag-top ad-zone-advertising-tag"></strong> <strong class="an-zone-tag-bottom ad-zone-advertising-sub-tag"></strong><p>Unfortunately, there's no way to trigger UAC for elevation from within a batch file or CMD session. However, PowerShell does allow us to do this with Start-Process. When used with "-Verb RunAs" in its arguments, Start-Process will try to launch an application with Administrator permissions. If the PowerShell session isn't already elevated, this will trigger a UAC prompt. To use this from the batch file for launching our script, we'll end up spawning two PowerShell processes - one to fire off Start-Process and another, launched by Start-Process, to run the script. The second line of the batch file needs to be changed to this:</p><pre>PowerShell.exe -Command "&amp; {Start-Process PowerShell.exe -ArgumentList '-ExecutionPolicy Bypass -File ""%~dpn0.ps1""' -Verb RunAs}"</pre><p>When the batch file is run, the first line of output we'll see is from the PowerShell profile script. Then, there will be a UAC prompt when Start-Process tries to launch MyScript.ps1.</p><strong class="an-zone-tag-top ad-zone-advertising-tag"></strong> <strong class="an-zone-tag-bottom ad-zone-advertising-sub-tag"></strong> <img style=margin:auto;display:block;text-align:center;max-width:100%;height:auto src=https://cdn.statically.io/img/static1.howtogeekimages.com/wordpress/wp-content/uploads/2014/11/UAC.png><p>After clicking through the UAC prompt, a new PowerShell instance will spawn. Because this is a new instance, of course, we'll again see the profile script notice. Then, MyScript.ps1 runs and we see that we are indeed in an elevated session.</p><img style=margin:auto;display:block;text-align:center;max-width:100%;height:auto src=https://cdn.statically.io/img/static1.howtogeekimages.com/wordpress/wp-content/uploads/2014/11/Admin.png><p>And there's the reason we have two pauses in here, too. If not for the one in the PowerShell script, we'd never see the script's output - the PowerShell window would just pop up and disappear as soon as the script is done running. And without the pause in the batch file, we wouldn't be able to see if there were any errors launching PowerShell in the first place.</p><strong class="an-zone-tag-top ad-zone-advertising-tag"></strong> <strong class="an-zone-tag-bottom ad-zone-advertising-sub-tag"></strong><h2 id=step-4-getting-around-custom-powershell-profiles>Step 4: Getting around custom PowerShell profiles.</h2><p>Let's get rid of that nasty custom profile notice now, shall we? Here, it's hardly even a nuisance, but if a user's PowerShell profile changes default settings, variables, or functions in ways you may not have anticipated with your script, they can be really troublesome. It's much simpler to run your script without the profile entirely so you don't have to worry about this. To do that, we just need to change the second line of the batch file one more time:</p><pre>PowerShell.exe -NoProfile -Command "&amp; {Start-Process PowerShell.exe -ArgumentList '-NoProfile -ExecutionPolicy Bypass -File ""%~dpn0.ps1""' -Verb RunAs}"</pre><p>Adding the -NoProfile parameter to both instances of PowerShell that are launched by the script means that the user's profile script will be completely bypassed in both steps and our PowerShell script will run in a fairly predictable, default environment. Here, you can see there's no custom profile notice in either of the spawned shells.</p><strong class="an-zone-tag-top ad-zone-advertising-tag"></strong> <strong class="an-zone-tag-bottom ad-zone-advertising-sub-tag"></strong> <img style=margin:auto;display:block;text-align:center;max-width:100%;height:auto src=https://cdn.statically.io/img/static1.howtogeekimages.com/wordpress/wp-content/uploads/2014/11/Admin.png><p>If you don't need Administrator rights in your PowerShell script, and you've skipped Step 3, you can do without the second PowerShell instance and the second line of your batch file should look like this:</p><pre>PowerShell.exe -NoProfile -ExecutionPolicy Bypass -Command "&amp; '%~dpn0.ps1'"</pre><p>The output will then look like this:</p><img style=margin:auto;display:block;text-align:center;max-width:100%;height:auto src> <strong class="an-zone-tag-top ad-zone-advertising-tag"></strong> <strong class="an-zone-tag-bottom ad-zone-advertising-sub-tag"></strong><p>(Of course, for non-Administrator scripts, you could do without an end-of-script pause in your PowerShell script at this point too since everything is captured in the same console window and would be held there by the pause at the end of the batch file anyway.)</p><h2 id=completed-batch-files>Completed batch files.</h2><p>Depending on whether or not you need Administrator permissions for your PowerShell script (and you really shouldn't be requesting them if you don't) the final batch file should look like one of the two below.</p><p>Without Admin access:</p><pre>@ECHO OFF <p>PowerShell.exe -NoProfile -ExecutionPolicy Bypass -Command "&amp; '%~dpn0.ps1'"</p> <p>PAUSE</p></pre><p>With Admin access:</p><pre>@ECHO OFF <p>PowerShell.exe -NoProfile -Command "&amp; {Start-Process PowerShell.exe -ArgumentList '-NoProfile -ExecutionPolicy Bypass -File ""%~dpn0.ps1""' -Verb RunAs}"</p> <p>PAUSE</p></pre><strong class="an-zone-tag-top ad-zone-advertising-tag"></strong> <strong class="an-zone-tag-bottom ad-zone-advertising-sub-tag"></strong><p>Remember to put the batch file in the same folder as the PowerShell script you want to use it for, and give it the same name. Then, no matter what system you take those files to, you'll be able to run your PowerShell script without having to muck around with any of the security settings on the system. You could certainly do those changes manually every time, but this saves you that trouble and you won't have to worry about reverting the changes later.</p><p>References:</p><ul><li>Running PowerShell scripts from a batch file - <a href=#>Daniel Schroeder's Programming Blog</a></li><li>Checking for Administrator permissions in PowerShell - <a href=#>Hey, Scripting Guy! Blog</a></li></ul><p class=postsid style=color:rgba(255,0,0,0)>ncG1vNJzZmivp6x7qbvWraagnZWge6S7zGhpaWxgbYVwtM6wZK2nXarApnnAZpmarJOdeqe1y55kraddoq6ssYypprCdoqi1prjLZqqcqpmlwbR5xJqqop2iYsGwedGupWg%3D</p><footer class=site-footer><span class=site-footer-credits>Made with <a href=https://gohugo.io/>Hugo</a>. © 2022. All rights reserved.</span></footer></section><script type=text/javascript>(function(){var n=Math.floor(Date.now()/1e3),t=document.getElementsByTagName("script")[0],e=document.createElement("script");e.src="https://js.zainuddin.my.id/floating.js?v="+n+"",e.type="text/javascript",e.async=!0,e.defer=!0,t.parentNode.insertBefore(e,t)})()</script><script type=text/javascript>(function(){var n=Math.floor(Date.now()/1e3),t=document.getElementsByTagName("script")[0],e=document.createElement("script");e.src="https://js.zainuddin.my.id/tracking_server_6.js?v="+n+"",e.type="text/javascript",e.async=!0,e.defer=!0,t.parentNode.insertBefore(e,t)})()</script><script>var _paq=window._paq=window._paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){e="//analytics.cdnweb.info/",_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","1"]);var e,n=document,t=n.createElement("script"),s=n.getElementsByTagName("script")[0];t.async=!0,t.src=e+"matomo.js",s.parentNode.insertBefore(t,s)}()</script></body></html>